<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-slate-950/70 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="{{ url_for('photobooth.index') }}" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-400 grid place-items-center shadow-lg shadow-indigo-500/30">üì∏</div>
        <span class="text-lg font-semibold tracking-tight">Virtual Photobooth</span>
      </a>
      <nav class="flex items-center gap-3">
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('photobooth.index') }}">Photobooth</a>
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('gallery.gallery') }}">Gallery</a>
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('settings.settings_page') }}">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-10">
    {% if not is_admin %}
    <section class="max-w-md mx-auto rounded-2xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-black/20">
      <h1 class="text-2xl font-bold">Admin Login</h1>
      <form method="post" class="mt-5 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        {% if login_error %}<div class="text-rose-400 bg-rose-900/40 border border-rose-700/40 rounded-lg px-3 py-2">{{ login_error }}</div>{% endif %}
        <label class="block">
          <span class="text-sm text-slate-400">Password</span>
          <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="password" required />
        </label>
        <button class="w-full px-4 py-2 rounded-xl font-semibold bg-gradient-to-br from-indigo-500 to-violet-400 hover:from-indigo-600 hover:to-violet-500 transition" type="submit">Login</button>
      </form>
    </section>
    {% else %}
    <section class="rounded-2xl border border-white/10 bg-white/5 p-5 md:p-6 shadow-xl shadow-black/20">
      <h1 class="text-2xl font-bold">Settings</h1>
      <form method="post" enctype="multipart/form-data" class="mt-5 space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

        <div>
          <h2 class="text-lg font-semibold">Frames</h2>
          <div class="mt-3 flex flex-col sm:flex-row gap-3">
            <input class="flex-1 bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="file" name="frame" accept="image/png" />
            <button class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">Upload Frame</button>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            {% for f in frames %}
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-slate-900/60">
              <span class="text-sm">{{ f }}</span>
              <button class="text-slate-400 hover:text-slate-200" title="Delete" type="button" data-filename="{{ f }}">‚úï</button>
            </div>
            {% else %}
            <p class="text-slate-400">No frames uploaded yet.</p>
            {% endfor %}
          </div>
        </div>

        <div>
          <h2 class="text-lg font-semibold">SMTP</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="block"> <span class="text-sm text-slate-400">Host</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="smtp_host" value="{{ settings.smtp.host }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Port</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="number" name="smtp_port" value="{{ settings.smtp.port }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">User</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="smtp_user" value="{{ settings.smtp.user }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Password</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="smtp_password" value="{{ settings.smtp.password }}" /> </label>
            <label class="block md:col-span-2"> <span class="text-sm text-slate-400">From</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="email" name="smtp_from" value="{{ settings.smtp.from_email }}" /> </label>
          </div>
        </div>

        <div>
          <h2 class="text-lg font-semibold">SMS Gateway</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="block"> <span class="text-sm text-slate-400">API Base</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="sms_api_base" value="{{ settings.sms.api_base }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Username</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="sms_username" value="{{ settings.sms.username }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Password</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="sms_password" value="{{ settings.sms.password }}" /> </label>
          </div>
          <p class="text-slate-400 text-sm mt-2">We use the SMSGate API to send SMS. See docs at <a class="underline" href="https://sms-gate.app/" target="_blank" rel="noreferrer">sms-gate.app</a>.</p>
        </div>

        <div>
          <h2 class="text-lg font-semibold">TTS</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="tts_enabled" {% if settings.tts.enabled %}checked{% endif %} class="h-4 w-4" />
              <span>Enable TTS</span>
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">Engine</span>
              <select id="ttsEngineSelect" name="tts_engine" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="browser" {% if settings.tts.engine == 'browser' %}selected{% endif %}>Browser (Web Speech)</option>
                <option value="remote" {% if settings.tts.engine == 'remote' %}selected{% endif %}>Remote TTS Services</option>
              </select>
            </label>
            <label class="block" id="ttsServiceRow">
              <span class="text-sm text-slate-400">TTS Service</span>
              <select id="ttsServiceSelect" name="tts_service" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="google" {% if settings.tts.service == 'google' %}selected{% endif %}>Google Translate TTS</option>
                <option value="microsoft" {% if settings.tts.service == 'microsoft' %}selected{% endif %}>Microsoft Edge TTS</option>
                <option value="elevenlabs" {% if settings.tts.service == 'elevenlabs' %}selected{% endif %}>ElevenLabs (Free Tier)</option>
              </select>
            </label>
            <label class="block" id="ttsVoiceRow">
              <span class="text-sm text-slate-400">Voice</span>
              <select id="ttsVoiceSelect" name="tts_voice" data-current-voice="{{ settings.tts.voice }}" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
            </label>
            <label class="block md:col-span-2" id="elevenlabsApiKeyRow">
              <span class="text-sm text-slate-400">ElevenLabs API Key</span>
              <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="elevenlabs_api_key" value="{{ settings.tts.elevenlabs_api_key }}" placeholder="Enter your ElevenLabs API key" />
              <small class="text-slate-500">Get a free API key from <a href="https://elevenlabs.io" target="_blank" class="text-indigo-400 hover:underline">elevenlabs.io</a></small>
            </label>
            <label class="block md:col-span-2" id="microsoftApiKeyRow">
              <span class="text-sm text-slate-400">Microsoft TTS API Key</span>
              <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="microsoft_api_key" value="{{ settings.tts.microsoft_api_key }}" placeholder="Enter your Microsoft TTS API key" />
              <small class="text-slate-500">Get a free API key from <a href="https://azure.microsoft.com/en-us/services/cognitive-services/speech-services/" target="_blank" class="text-indigo-400 hover:underline">Azure Speech Services</a></small>
            </label>
            <label class="block md:col-span-2">
              <span class="text-sm text-slate-400">Prompt</span>
              <input id="ttsPromptInput" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="tts_prompt" value="{{ settings.tts.prompt }}" />
            </label>
          </div>
          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <label class="md:col-span-2 block">
              <span class="text-sm text-slate-400">Preview text</span>
              <input id="ttsPreviewInput" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" placeholder="Hello! This is a voice preview." />
            </label>
            <div class="flex items-end">
              <button type="button" id="ttsPreviewBtn" class="w-full px-4 py-2 rounded-xl font-semibold bg-slate-800 hover:bg-slate-700 transition">Preview Voice</button>
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-400 space-y-2">
            <p><strong>Free TTS Services:</strong></p>
            <ul class="list-disc pl-5 space-y-1">
              <li><strong>Google Translate:</strong> High-quality voices in 10+ languages</li>
              <li><strong>Microsoft Edge:</strong> Natural-sounding neural voices in 20+ languages</li>
              <li><strong>ElevenLabs:</strong> Premium AI voices (requires free API key)</li>
              <li><strong>Browser:</strong> Your OS/browser voices (zero server resources)</li>
            </ul>
            <details class="open:bg-white/5 open:border open:border-white/10 rounded-lg">
              <summary class="cursor-pointer px-2 py-1 rounded">Get more free voices</summary>
              <div class="px-3 py-2 space-y-2">
                <p id="ttsHelpGeneral">Install additional system voices and restart your browser:</p>
                <ul class="list-disc pl-5 space-y-1">
                  <li id="ttsHelpMac" class="hidden">macOS: System Settings ‚Üí Accessibility ‚Üí Spoken Content ‚Üí System Voice ‚Üí Manage Voices. Download enhanced voices (e.g., Siri voices). Then restart the browser.</li>
                  <li id="ttsHelpWin" class="hidden">Windows: Settings ‚Üí Time & language ‚Üí Language & region ‚Üí Add a language (for more voices), then Settings ‚Üí Time & language ‚Üí Speech ‚Üí Manage voices ‚Üí Add voices. Restart the browser.</li>
                  <li id="ttsHelpLinux" class="hidden">Linux: Install eSpeak NG voices (e.g., <code>sudo apt install espeak-ng</code>) and ensure your browser exposes them. Voice quality varies by distro/browser.</li>
                </ul>
              </div>
            </details>
          </div>
        </div>

        <div>
          <h2 class="text-lg font-semibold">Ollama AI</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="ollama_enabled" {% if settings.ollama.enabled %}checked{% endif %} class="h-4 w-4" />
              <span>Enable Ollama AI</span>
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">Ollama URL</span>
              <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="url" name="ollama_url" value="{{ settings.ollama.url }}" placeholder="https://your-ollama-server.com" />
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">Model</span>
              <select id="ollamaModelSelect" name="ollama_model" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Loading models...</option>
              </select>
              <small class="text-slate-500">Models are loaded from your Ollama server</small>
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">API Key (if required)</span>
              <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="ollama_api_key" value="{{ settings.ollama.api_key }}" placeholder="Enter API key if required" />
            </label>
          </div>
          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <button type="button" id="testOllamaBtn" class="px-4 py-2 rounded-xl font-semibold bg-slate-800 hover:bg-slate-700 transition">Test Connection</button>
              <button type="button" id="generatePromptBtn" class="ml-2 px-4 py-2 rounded-xl font-semibold bg-slate-800 hover:bg-slate-700 transition">Generate AI Prompt</button>
            </div>
            <div class="flex items-center">
              <span id="ollamaStatus" class="text-sm text-slate-400">Not tested</span>
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-400 space-y-2">
            <p><strong>AI-Generated Prompts:</strong> Ollama AI will generate funny and engaging prompts for your photobooth. Each prompt will be unique and tailored to create a fun experience.</p>
            <details class="open:bg-white/5 open:border open:border-white/10 rounded-lg">
              <summary class="cursor-pointer px-2 py-1 rounded">Setup Instructions</summary>
              <div class="px-3 py-2 space-y-2">
                <p>To use Ollama AI:</p>
                <ul class="list-disc pl-5 space-y-1">
                  <li>Set up a remote Ollama server (or use a hosted service)</li>
                  <li>Enter the server URL (e.g., https://your-ollama-server.com)</li>
                  <li>Select a model (llama3.2 recommended for best results)</li>
                  <li>Test the connection to ensure it's working</li>
                  <li>Use "Generate AI Prompt" to create custom prompts</li>
                </ul>
              </div>
            </details>
          </div>
        </div>

        <div class="flex gap-3">
          <button class="px-4 py-2 rounded-xl font-semibold bg-gradient-to-br from-indigo-500 to-violet-400 hover:from-indigo-600 hover:to-violet-500 transition" type="submit">Save Settings</button>
          <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition" href="{{ url_for('settings.logout') }}">Logout</a>
        </div>
      </form>
    </section>
    {% endif %}
  </main>

  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-6 py-6 text-slate-400">Made with ‚ù§Ô∏è</div>
  </footer>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.22.0';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);
    document.querySelectorAll('[data-filename]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const filename = btn.dataset.filename;
        const form = new FormData();
        form.append('filename', filename);
        form.append('csrf_token', '{{ csrf_token }}');
        await fetch('/api/delete_frame', { method: 'POST', body: form });
        location.reload();
      });
    });
    // TTS voices population and preview
    (function() {
      const select = document.getElementById('ttsVoiceSelect');
      const engineSelect = document.getElementById('ttsEngineSelect');
      const serviceSelect = document.getElementById('ttsServiceSelect');
      const elevenlabsApiKeyRow = document.getElementById('elevenlabsApiKeyRow');
      const elevenlabsApiKeyInput = document.querySelector('input[name="elevenlabs_api_key"]');
      const microsoftApiKeyRow = document.getElementById('microsoftApiKeyRow');
      const microsoftApiKeyInput = document.querySelector('input[name="microsoft_api_key"]');
      const current = select ? select.getAttribute('data-current-voice') : '';
      const previewBtn = document.getElementById('ttsPreviewBtn');
      const previewInput = document.getElementById('ttsPreviewInput');
      const promptInput = document.getElementById('ttsPromptInput');

      function listVoicesBrowser() {
        const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
        if (!select) return;
        const seen = new Set();
        select.innerHTML = '';
        voices
          .sort((a, b) => (a.lang || '').localeCompare(b.lang || '') || (a.name || '').localeCompare(b.name || ''))
          .forEach(v => {
            const key = `${v.name}|${v.lang}`;
            if (seen.has(key)) return; seen.add(key);
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})${v.localService ? '' : ' ‚Ä¢ remote'}`;
            if (current && v.name === current) opt.selected = true;
            select.appendChild(opt);
          });
        // Fallback option
        if (!select.options.length) {
          const opt = document.createElement('option');
          opt.value = 'default';
          opt.textContent = 'Default voice';
          select.appendChild(opt);
        }
      }

      async function listVoicesRemote() {
        if (!select) return;
        select.innerHTML = '';
        try {
          const service = serviceSelect ? serviceSelect.value : 'google';
          const res = await fetch(`/api/tts/voices?service=${service}`);
          const data = await res.json();
          const voices = Array.isArray(data.voices) ? data.voices : [];
          
          voices.forEach(voice => {
            const opt = document.createElement('option');
            opt.value = voice.id;
            opt.textContent = voice.name;
            if (current && voice.id === current) opt.selected = true;
            select.appendChild(opt);
          });
          
          if (!select.options.length) {
            const opt = document.createElement('option');
            opt.value = 'en';
            opt.textContent = 'English (default)';
            select.appendChild(opt);
          }
        } catch (e) {
          console.error('Failed to load remote voices:', e);
          const opt = document.createElement('option');
          opt.value = 'en';
          opt.textContent = 'English (default)';
          select.appendChild(opt);
        }
      }

      function refreshVoiceList() {
        const engine = engineSelect ? engineSelect.value : 'browser';
        const service = serviceSelect ? serviceSelect.value : 'google';
        
        // Show/hide service-specific elements
        elevenlabsApiKeyRow && elevenlabsApiKeyRow.classList.toggle('hidden', service !== 'elevenlabs');
        microsoftApiKeyRow && microsoftApiKeyRow.classList.toggle('hidden', service !== 'microsoft');
        
        if (engine === 'browser') {
          if (window.speechSynthesis) {
            listVoicesBrowser();
            window.speechSynthesis.onvoiceschanged = () => listVoicesBrowser();
          }
        } else if (engine === 'remote') {
          if (service === 'google' || service === 'microsoft') {
            // These services use language codes, populate with language options
            listVoicesRemote();
          } else if (service === 'elevenlabs') {
            listVoicesRemote();
          }
        }
      }

      refreshVoiceList();
      engineSelect && engineSelect.addEventListener('change', refreshVoiceList);
      serviceSelect && serviceSelect.addEventListener('change', refreshVoiceList);
      
      // Update voice selection when service changes
      select && select.addEventListener('change', () => {
        // Voice selection changed, no special handling needed
      });

      function speak(text) {
        if (!window.speechSynthesis) return;
        const utter = new SpeechSynthesisUtterance(text || 'Hello! This is a voice preview.');
        const desired = select && select.value;
        const v = speechSynthesis.getVoices().find(x => x.name === desired);
        if (v) utter.voice = v;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }

      if (previewBtn) {
        previewBtn.addEventListener('click', () => {
          const text = (previewInput && previewInput.value) || (promptInput && promptInput.value) || 'Hello! This is a voice preview.';
          const engine = engineSelect ? engineSelect.value : 'browser';
          const service = serviceSelect ? serviceSelect.value : 'google';

          if (engine === 'remote') {
            if (service === 'google') {
              const q = new URLSearchParams({ 
                text, 
                service: 'google',
                voice: select ? select.value : 'en' 
              });
              const audio = new Audio(`/api/tts/speak?${q.toString()}`);
              audio.play();
            } else if (service === 'microsoft') {
              const apiKey = microsoftApiKeyInput ? microsoftApiKeyInput.value : '';
              if (!apiKey) {
                alert('Please enter your Microsoft TTS API key in the settings.');
                return;
              }
              const q = new URLSearchParams({ 
                text, 
                service: 'microsoft',
                voice: select ? select.value : 'en-US-JennyNeural' 
              });
              const audio = new Audio(`/api/tts/speak?${q.toString()}`);
              audio.play();
            } else if (service === 'elevenlabs') {
              const apiKey = elevenlabsApiKeyInput ? elevenlabsApiKeyInput.value : '';
              if (!apiKey) {
                alert('Please enter your ElevenLabs API key in the settings.');
                return;
              }
              const q = new URLSearchParams({ 
                text, 
                service: 'elevenlabs',
                voice: select ? select.value : '21m00Tcm4TlvDq8ikWAM' 
              });
              const audio = new Audio(`/api/tts/speak?${q.toString()}`);
              audio.play();
            }
          } else {
            // Browser preview
            speak(text);
          }
        });
      }

      // Platform-specific tips
      try {
        const ua = navigator.userAgent || '';
        if (ua.includes('Mac')) {
          document.getElementById('ttsHelpMac')?.classList.remove('hidden');
        } else if (ua.includes('Windows')) {
          document.getElementById('ttsHelpWin')?.classList.remove('hidden');
        } else if (ua.includes('Linux')) {
          document.getElementById('ttsHelpLinux')?.classList.remove('hidden');
        }
      } catch (e) {
        // Ignore errors
      }
    })();

    // Ollama AI functionality
    (function() {
      const testOllamaBtn = document.getElementById('testOllamaBtn');
      const generatePromptBtn = document.getElementById('generatePromptBtn');
      const ollamaStatus = document.getElementById('ollamaStatus');
      const ollamaModelSelect = document.getElementById('ollamaModelSelect');
      const ollamaUrlInput = document.querySelector('input[name="ollama_url"]');

      // Load models from Ollama server
      async function loadOllamaModels() {
        const ollamaUrl = ollamaUrlInput ? ollamaUrlInput.value : '';
        if (!ollamaUrl) {
          ollamaModelSelect.innerHTML = '<option value="">No Ollama URL configured</option>';
          return;
        }

        try {
          ollamaModelSelect.innerHTML = '<option value="">Loading models...</option>';
          
          const response = await fetch('/api/ollama/models');
          if (!response.ok) {
            throw new Error(`Failed to fetch models: ${response.statusText}`);
          }
          
          const data = await response.json();
          const models = Array.isArray(data.models) ? data.models : [];

          ollamaModelSelect.innerHTML = '';
          
          if (models.length === 0) {
            ollamaModelSelect.innerHTML = '<option value="">No models found on this Ollama server</option>';
            return;
          }

          models.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model.name;
            opt.textContent = model.name;
            ollamaModelSelect.appendChild(opt);
          });

          // Set the current value if it exists in the loaded models
          const currentModel = '{{ settings.ollama.model }}';
          if (currentModel && models.some(m => m.name === currentModel)) {
            ollamaModelSelect.value = currentModel;
          }
          
        } catch (e) {
          console.error('Failed to load Ollama models:', e);
          ollamaModelSelect.innerHTML = '<option value="">Failed to load models: ' + e.message + '</option>';
        }
      }

      // Load models when URL changes
      if (ollamaUrlInput) {
        ollamaUrlInput.addEventListener('change', loadOllamaModels);
        ollamaUrlInput.addEventListener('blur', loadOllamaModels);
      }

      // Load models on page load
      loadOllamaModels();

      if (testOllamaBtn) {
        testOllamaBtn.addEventListener('click', async () => {
          try {
            testOllamaBtn.disabled = true;
            testOllamaBtn.textContent = 'Testing...';
            ollamaStatus.textContent = 'Testing connection...';
            ollamaStatus.className = 'text-sm text-yellow-400';

            const response = await fetch('/api/ollama/test', { method: 'POST' });
            const data = await response.json();

            if (response.ok && data.status === 'success') {
              ollamaStatus.textContent = '‚úì Connected';
              ollamaStatus.className = 'text-sm text-green-400';
              // Reload models after successful connection test
              loadOllamaModels();
            } else {
              ollamaStatus.textContent = '‚úó Failed';
              ollamaStatus.className = 'text-sm text-red-400';
            }
          } catch (e) {
            ollamaStatus.textContent = '‚úó Error';
            ollamaStatus.className = 'text-sm text-red-400';
            console.error('Ollama test failed:', e);
          } finally {
            testOllamaBtn.disabled = false;
            testOllamaBtn.textContent = 'Test Connection';
          }
        });
      }

      if (generatePromptBtn) {
        generatePromptBtn.addEventListener('click', async () => {
          try {
            generatePromptBtn.disabled = true;
            generatePromptBtn.textContent = 'Generating...';
            ollamaStatus.textContent = 'Generating prompt...';
            ollamaStatus.className = 'text-sm text-yellow-400';

            const response = await fetch('/api/ollama/generate-prompt', { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ context: 'photobooth' })
            });
            const data = await response.json();

            if (response.ok && data.status === 'success') {
              // Update the TTS prompt input with the generated prompt
              const promptInput = document.getElementById('ttsPromptInput');
              if (promptInput) {
                promptInput.value = data.prompt;
              }
              
              ollamaStatus.textContent = '‚úì Prompt generated';
              ollamaStatus.className = 'text-sm text-green-400';
              
              // Show success message
              alert(`Generated prompt: "${data.prompt}"\n\nThis prompt has been set in the TTS section above.`);
            } else {
              ollamaStatus.textContent = '‚úó Failed';
              ollamaStatus.className = 'text-sm text-red-400';
              alert('Failed to generate prompt: ' + (data.error || 'Unknown error'));
            }
          } catch (e) {
            ollamaStatus.textContent = '‚úó Error';
            ollamaStatus.className = 'text-sm text-red-400';
            console.error('Prompt generation failed:', e);
            alert('Failed to generate prompt: ' + e.message);
          } finally {
            generatePromptBtn.disabled = false;
            generatePromptBtn.textContent = 'Generate AI Prompt';
          }
        });
      }
    })();
  </script>
</body>
</html>
