<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-slate-950/70 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="{{ url_for('photobooth.index') }}" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-400 grid place-items-center shadow-lg shadow-indigo-500/30">📸</div>
        <span class="text-lg font-semibold tracking-tight">Virtual Photobooth</span>
      </a>
      <nav class="flex items-center gap-3">
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('photobooth.index') }}">Photobooth</a>
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('gallery.gallery') }}">Gallery</a>
        <a class="px-3 py-2 rounded-lg hover:bg-white/5 transition" href="{{ url_for('settings.settings_page') }}">Settings</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-10">
    {% if not is_admin %}
    <section class="max-w-md mx-auto rounded-2xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-black/20">
      <h1 class="text-2xl font-bold">Admin Login</h1>
      <form method="post" class="mt-5 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        {% if login_error %}<div class="text-rose-400 bg-rose-900/40 border border-rose-700/40 rounded-lg px-3 py-2">{{ login_error }}</div>{% endif %}
        <label class="block">
          <span class="text-sm text-slate-400">Password</span>
          <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="password" required />
        </label>
        <button class="w-full px-4 py-2 rounded-xl font-semibold bg-gradient-to-br from-indigo-500 to-violet-400 hover:from-indigo-600 hover:to-violet-500 transition" type="submit">Login</button>
      </form>
    </section>
    {% else %}
    <section class="rounded-2xl border border-white/10 bg-white/5 p-5 md:p-6 shadow-xl shadow-black/20">
      <h1 class="text-2xl font-bold">Settings</h1>
      <form method="post" enctype="multipart/form-data" class="mt-5 space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

        <div>
          <h2 class="text-lg font-semibold">Frames</h2>
          <div class="mt-3 flex flex-col sm:flex-row gap-3">
            <input class="flex-1 bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="file" name="frame" accept="image/png" />
            <button class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">Upload Frame</button>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            {% for f in frames %}
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-slate-900/60">
              <span class="text-sm">{{ f }}</span>
              <button class="text-slate-400 hover:text-slate-200" title="Delete" type="button" data-filename="{{ f }}">✕</button>
            </div>
            {% else %}
            <p class="text-slate-400">No frames uploaded yet.</p>
            {% endfor %}
          </div>
        </div>

        <div>
          <h2 class="text-lg font-semibold">SMTP</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="block"> <span class="text-sm text-slate-400">Host</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="smtp_host" value="{{ settings.smtp.host }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Port</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="number" name="smtp_port" value="{{ settings.smtp.port }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">User</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="smtp_user" value="{{ settings.smtp.user }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Password</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="smtp_password" value="{{ settings.smtp.password }}" /> </label>
            <label class="block md:col-span-2"> <span class="text-sm text-slate-400">From</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="email" name="smtp_from" value="{{ settings.smtp.from_email }}" /> </label>
          </div>
        </div>

        <div>
          <h2 class="text-lg font-semibold">SMS Gateway</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="block"> <span class="text-sm text-slate-400">API Base</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="sms_api_base" value="{{ settings.sms.api_base }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Username</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="sms_username" value="{{ settings.sms.username }}" /> </label>
            <label class="block"> <span class="text-sm text-slate-400">Password</span> <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="password" name="sms_password" value="{{ settings.sms.password }}" /> </label>
          </div>
          <p class="text-slate-400 text-sm mt-2">We use the SMSGate API to send SMS. See docs at <a class="underline" href="https://sms-gate.app/" target="_blank" rel="noreferrer">sms-gate.app</a>.</p>
        </div>

        <div>
          <h2 class="text-lg font-semibold">TTS</h2>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="tts_enabled" {% if settings.tts.enabled %}checked{% endif %} class="h-4 w-4" />
              <span>Enable TTS</span>
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">Engine</span>
              <select id="ttsEngineSelect" name="tts_engine" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="browser" {% if settings.tts.engine == 'browser' %}selected{% endif %}>Browser (Web Speech)</option>
                <option value="piper" {% if settings.tts.engine == 'piper' %}selected{% endif %}>Piper (lightweight local)</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm text-slate-400">Voice</span>
              <select id="ttsVoiceSelect" name="tts_voice" data-current-voice="{{ settings.tts.voice }}" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
              <small class="text-slate-500">For Piper, this is the model filename (e.g., en_US-amy-low.onnx) under piper/models.</small>
            </label>
            <label class="block md:col-span-2">
              <span class="text-sm text-slate-400">Prompt</span>
              <input id="ttsPromptInput" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="tts_prompt" value="{{ settings.tts.prompt }}" />
            </label>
          <label class="block md:col-span-2" id="piperModelRow">
            <span class="text-sm text-slate-400">Piper model path</span>
            <input class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" name="piper_model" value="{{ settings.tts.piper_model }}" />
          </label>
          </div>
          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <label class="md:col-span-2 block">
              <span class="text-sm text-slate-400">Preview text</span>
              <input id="ttsPreviewInput" class="mt-1 w-full bg-slate-900/60 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" type="text" placeholder="Hello! This is a voice preview." />
            </label>
            <div class="flex items-end">
              <button type="button" id="ttsPreviewBtn" class="w-full px-4 py-2 rounded-xl font-semibold bg-slate-800 hover:bg-slate-700 transition">Preview Voice</button>
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-400 space-y-2">
            <p>Voices are provided by your browser/OS (Web Speech API). Availability varies by device and language.</p>
            <details class="open:bg-white/5 open:border open:border-white/10 rounded-lg">
              <summary class="cursor-pointer px-2 py-1 rounded">Get more free voices</summary>
              <div class="px-3 py-2 space-y-2">
                <p id="ttsHelpGeneral">Install additional system voices and restart your browser:</p>
                <ul class="list-disc pl-5 space-y-1">
                  <li id="ttsHelpMac" class="hidden">macOS: System Settings → Accessibility → Spoken Content → System Voice → Manage Voices. Download enhanced voices (e.g., Siri voices). Then restart the browser.</li>
                  <li id="ttsHelpWin" class="hidden">Windows: Settings → Time & language → Language & region → Add a language (for more voices), then Settings → Time & language → Speech → Manage voices → Add voices. Restart the browser.</li>
                  <li id="ttsHelpLinux" class="hidden">Linux: Install eSpeak NG voices (e.g., <code>sudo apt install espeak-ng</code>) and ensure your browser exposes them. Voice quality varies by distro/browser.</li>
                </ul>
              </div>
            </details>
          </div>
        </div>

        <div class="flex gap-3">
          <button class="px-4 py-2 rounded-xl font-semibold bg-gradient-to-br from-indigo-500 to-violet-400 hover:from-indigo-600 hover:to-violet-500 transition" type="submit">Save Settings</button>
          <a class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition" href="{{ url_for('settings.logout') }}">Logout</a>
        </div>
      </form>
    </section>
    {% endif %}
  </main>

  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-6 py-6 text-slate-400">Made with ❤️</div>
  </footer>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.22.0';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);
    document.querySelectorAll('[data-filename]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const filename = btn.dataset.filename;
        const form = new FormData();
        form.append('filename', filename);
        form.append('csrf_token', '{{ csrf_token }}');
        await fetch('/api/delete_frame', { method: 'POST', body: form });
        location.reload();
      });
    });
    // TTS voices population and preview
    (function() {
      const select = document.getElementById('ttsVoiceSelect');
      const engineSelect = document.getElementById('ttsEngineSelect');
      const current = select ? select.getAttribute('data-current-voice') : '';
      const previewBtn = document.getElementById('ttsPreviewBtn');
      const previewInput = document.getElementById('ttsPreviewInput');
      const promptInput = document.getElementById('ttsPromptInput');
      const piperModelRow = document.getElementById('piperModelRow');

      function listVoicesBrowser() {
        const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
        if (!select) return;
        const seen = new Set();
        select.innerHTML = '';
        voices
          .sort((a, b) => (a.lang || '').localeCompare(b.lang || '') || (a.name || '').localeCompare(b.name || ''))
          .forEach(v => {
            const key = `${v.name}|${v.lang}`;
            if (seen.has(key)) return; seen.add(key);
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})${v.localService ? '' : ' • remote'}`;
            if (current && v.name === current) opt.selected = true;
            select.appendChild(opt);
          });
        // Fallback option
        if (!select.options.length) {
          const opt = document.createElement('option');
          opt.value = 'default';
          opt.textContent = 'Default voice';
          select.appendChild(opt);
        }
      }

      async function listVoicesPiper() {
        if (!select) return;
        select.innerHTML = '';
        try {
          const res = await fetch('/api/tts/voices');
          const data = await res.json();
          const voices = Array.isArray(data) ? data : (data.voices || []);
          voices.forEach(v => {
            const id = typeof v === 'string' ? v : (v.name || v.id || v.voice || '');
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = id;
            if (current && id === current) opt.selected = true;
            select.appendChild(opt);
          });
          if (!select.options.length) {
            const opt = document.createElement('option');
            opt.value = 'en_US-amy-low.onnx';
            opt.textContent = 'en_US-amy-low.onnx';
            select.appendChild(opt);
          }
        } catch (e) {
          const opt = document.createElement('option');
          opt.value = 'en_US-amy-low.onnx';
          opt.textContent = 'en_US-amy-low.onnx';
          select.appendChild(opt);
        }
      }

      function refreshVoiceList() {
        const engine = engineSelect ? engineSelect.value : 'browser';
        piperModelRow && piperModelRow.classList.toggle('hidden', engine !== 'piper');
        if (engine === 'piper') {
          listVoicesPiper();
        } else {
          if (window.speechSynthesis) {
            listVoicesBrowser();
            window.speechSynthesis.onvoiceschanged = () => listVoicesBrowser();
          }
        }
      }

      refreshVoiceList();
      engineSelect && engineSelect.addEventListener('change', refreshVoiceList);

      function speak(text) {
        if (!window.speechSynthesis) return;
        const utter = new SpeechSynthesisUtterance(text || 'Hello! This is a voice preview.');
        const desired = select && select.value;
        const v = speechSynthesis.getVoices().find(x => x.name === desired);
        if (v) utter.voice = v;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      }

      if (previewBtn) {
        previewBtn.addEventListener('click', () => {
          const text = (previewInput && previewInput.value) || (promptInput && promptInput.value) || 'Hello! This is a voice preview.';
          const engine = engineSelect ? engineSelect.value : 'browser';
          if (engine === 'opentts') {
            const q = new URLSearchParams({ text, voice: select ? select.value : '' });
            const audio = new Audio(`/api/tts/speak?${q.toString()}`);
            audio.play();
          } else {
            // Browser preview
            const utter = new SpeechSynthesisUtterance(text);
            const v = (window.speechSynthesis && select) ? speechSynthesis.getVoices().find(x => x.name === select.value) : null;
            if (v) utter.voice = v;
            window.speechSynthesis && (speechSynthesis.cancel(), speechSynthesis.speak(utter));
          }
        });
      }

      // Platform-specific tips
      try {
        const ua = navigator.userAgent || '';
        const isMac = /Macintosh|Mac OS X/.test(ua);
        const isWin = /Windows/.test(ua);
        document.getElementById('ttsHelpMac').classList.toggle('hidden', !isMac);
        document.getElementById('ttsHelpWin').classList.toggle('hidden', !isWin);
        document.getElementById('ttsHelpLinux').classList.toggle('hidden', isMac || isWin);
      } catch (_) {}
    })();
  </script>
</body>
</html>
